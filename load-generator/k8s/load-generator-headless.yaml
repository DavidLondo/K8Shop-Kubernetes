---
apiVersion: v1
kind: ConfigMap
metadata:
  name: load-generator-headless-config
  namespace: bookstore
  labels:
    app: load-generator-headless
data:
  # Configuraci√≥n de Locust
  LOCUST_USERS: "30"
  LOCUST_SPAWN_RATE: "3"
  LOCUST_RUN_TIME: "10m"
  LOCUST_HOST: "http://catalog-service.bookstore.svc.cluster.local:8080"
  
  # Service endpoints - URLs de los microservicios
  CATALOG_SERVICE_URL: "http://catalog-service.bookstore.svc.cluster.local:8080"
  CART_SERVICE_URL: "http://cart-service.bookstore.svc.cluster.local:8080"
  ORDER_SERVICE_URL: "http://order-service.bookstore.svc.cluster.local:8080"
  RECOMMENDATION_SERVICE_URL: "http://recommendation-service.bookstore.svc.cluster.local:8080"
  
---
apiVersion: batch/v1
kind: Job
metadata:
  name: load-generator-headless
  namespace: bookstore
  labels:
    app: load-generator-headless
spec:
  ttlSecondsAfterFinished: 300  # Auto-delete after 5 minutes of completion
  backoffLimit: 2
  template:
    metadata:
      labels:
        app: load-generator-headless
    spec:
      restartPolicy: Never
      containers:
      - name: locust
        image: davidlondo/k8shop-load-generator:latest
        imagePullPolicy: IfNotPresent
        envFrom:
        - configMapRef:
            name: load-generator-headless-config
        resources:
          requests:
            cpu: 500m
            memory: 512Mi
          limits:
            cpu: 2000m
            memory: 2Gi
        # Headless mode (no web UI)
        command:
        - "locust"
        args:
        - "--headless"
        - "--users=$(LOCUST_USERS)"
        - "--spawn-rate=$(LOCUST_SPAWN_RATE)"
        - "--run-time=$(LOCUST_RUN_TIME)"
        - "--host=$(LOCUST_HOST)"
        - "--print-stats"
        - "--html=/tmp/report.html"
        - "--csv=/tmp/stats"
