apiVersion: v1
kind: ConfigMap
metadata:
  name: postgres-init-sql
  namespace: bookstore
data:
  00-init.sql: |
    DO $$
    BEGIN
      IF NOT EXISTS (SELECT FROM pg_roles WHERE rolname = 'bookstore_app') THEN
        CREATE ROLE bookstore_app LOGIN PASSWORD 'bookstore_pass';
      ELSE
        ALTER ROLE bookstore_app LOGIN PASSWORD 'bookstore_pass';
      END IF;
      ALTER ROLE bookstore_app SET search_path = public;
    END $$;
    \connect bookstore;
    DO $$
    DECLARE
      schema_name text;
    BEGIN
      FOR schema_name IN SELECT unnest(ARRAY['catalog','cart','inventory','order','payment','recommendation'])
      LOOP
        EXECUTE format('CREATE SCHEMA IF NOT EXISTS %I AUTHORIZATION postgres;', schema_name);
        EXECUTE format('GRANT USAGE ON SCHEMA %I TO bookstore_app;', schema_name);
        EXECUTE format('GRANT CREATE ON SCHEMA %I TO bookstore_app;', schema_name);
        EXECUTE format('GRANT CREATE, SELECT, INSERT, UPDATE, DELETE ON ALL TABLES IN SCHEMA %I TO bookstore_app;', schema_name);
        EXECUTE format('ALTER DEFAULT PRIVILEGES IN SCHEMA %I GRANT SELECT, INSERT, UPDATE, DELETE ON TABLES TO bookstore_app;', schema_name);
      END LOOP;
    END $$;
---
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: postgresql
  namespace: bookstore
spec:
  serviceName: postgresql
  replicas: 1
  selector:
    matchLabels:
      app: postgresql
  template:
    metadata:
      labels:
        app: postgresql
    spec:
      containers:
      - name: postgres
        image: postgres:16-alpine
        imagePullPolicy: IfNotPresent
        ports:
        - containerPort: 5432
          name: postgres
        envFrom:
        - secretRef:
            name: postgres-credentials
        volumeMounts:
        - name: data
          mountPath: /var/lib/postgresql/data
        - name: init-sql
          mountPath: /docker-entrypoint-initdb.d
        readinessProbe:
          exec:
            command: ["pg_isready", "-U", "postgres"]
          initialDelaySeconds: 20
          periodSeconds: 10
        livenessProbe:
          exec:
            command: ["pg_isready", "-U", "postgres"]
          initialDelaySeconds: 30
          periodSeconds: 10
      volumes:
      - name: init-sql
        configMap:
          name: postgres-init-sql
      - name: data
        emptyDir: {}
---
apiVersion: v1
kind: Service
metadata:
  name: postgresql
  namespace: bookstore
  labels:
    app: postgresql
spec:
  selector:
    app: postgresql
  ports:
  - name: postgres
    port: 5432
    targetPort: 5432
  type: ClusterIP
---
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: redis
  namespace: bookstore
spec:
  serviceName: redis
  replicas: 1
  selector:
    matchLabels:
      app: redis
  template:
    metadata:
      labels:
        app: redis
    spec:
      containers:
      - name: redis
        image: redis:7.4-alpine
        args: ["--appendonly", "yes"]
        ports:
        - containerPort: 6379
          name: redis
        readinessProbe:
          tcpSocket:
            port: 6379
          initialDelaySeconds: 5
          periodSeconds: 10
        livenessProbe:
          tcpSocket:
            port: 6379
          initialDelaySeconds: 10
          periodSeconds: 10
        volumeMounts:
        - name: data
          mountPath: /data
      volumes:
      - name: data
        emptyDir: {}
---
apiVersion: v1
kind: Service
metadata:
  name: redis
  namespace: bookstore
  labels:
    app: redis
spec:
  selector:
    app: redis
  ports:
  - name: redis
    port: 6379
    targetPort: 6379
  type: ClusterIP
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: dynamodb
  namespace: bookstore
spec:
  replicas: 1
  selector:
    matchLabels:
      app: dynamodb
  template:
    metadata:
      labels:
        app: dynamodb
    spec:
      containers:
      - name: dynamodb
        image: amazon/dynamodb-local:latest
        ports:
        - containerPort: 8000
          name: http
        readinessProbe:
          tcpSocket:
            port: 8000
          initialDelaySeconds: 5
          periodSeconds: 10
        livenessProbe:
          tcpSocket:
            port: 8000
          initialDelaySeconds: 10
          periodSeconds: 10
        volumeMounts:
        - name: data
          mountPath: /home/dynamodblocal/data
      volumes:
      - name: data
        emptyDir: {}
---
apiVersion: v1
kind: Service
metadata:
  name: dynamodb
  namespace: bookstore
  labels:
    app: dynamodb
spec:
  selector:
    app: dynamodb
  ports:
  - name: http
    port: 8000
    targetPort: 8000
  type: ClusterIP
