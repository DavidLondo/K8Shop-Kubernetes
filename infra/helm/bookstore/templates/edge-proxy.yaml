{{- if .Values.edgeProxy.enabled }}
apiVersion: v1
kind: ConfigMap
metadata:
  name: edge-proxy-config
  namespace: {{ .Release.Namespace }}
  labels:
    app: edge-proxy
data:
  nginx.conf: |
    user  nginx;
    worker_processes  auto;

    error_log  /var/log/nginx/error.log warn;
    pid        /var/run/nginx.pid;

    events {
      worker_connections  1024;
    }

    http {
      include       /etc/nginx/mime.types;
      default_type  application/octet-stream;
      sendfile        on;
      keepalive_timeout  65;
      gzip on;
      proxy_http_version 1.1;
      proxy_set_header Host $host;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header X-Forwarded-Proto $scheme;

      upstream frontend_upstream {
        server frontend.{{ .Release.Namespace }}.svc.cluster.local:80;
      }

      upstream catalog_upstream {
        server catalog-service.{{ .Release.Namespace }}.svc.cluster.local:8080;
      }

      upstream cart_upstream {
        server cart-service.{{ .Release.Namespace }}.svc.cluster.local:8080;
      }

      upstream order_upstream {
        server order-service.{{ .Release.Namespace }}.svc.cluster.local:8000;
      }

      upstream recommendation_upstream {
        server recommendation-service.{{ .Release.Namespace }}.svc.cluster.local:8080;
      }

      upstream inventory_upstream {
        server inventory-service.{{ .Release.Namespace }}.svc.cluster.local:8080;
      }

      upstream payment_upstream {
        server payment-service.{{ .Release.Namespace }}.svc.cluster.local:8080;
      }

      upstream notification_upstream {
        server notification-service.{{ .Release.Namespace }}.svc.cluster.local:8080;
      }

      server {
        listen       80;
        server_name  _;

        location = /healthz {
          access_log off;
          return 200 '{"ok":true}';
          add_header Content-Type application/json;
        }

        location = /api/catalog/healthz {
          proxy_pass http://catalog_upstream/healthz;
        }

        location = /api/cart/healthz {
          proxy_pass http://cart_upstream/healthz;
        }

        location = /api/orders/healthz {
          proxy_pass http://order_upstream/healthz;
        }

        location = /api/recommendations/healthz {
          proxy_pass http://recommendation_upstream/healthz;
        }

        location = /api/inventory/healthz {
          proxy_pass http://inventory_upstream/healthz;
        }

        location = /api/payment/healthz {
          proxy_pass http://payment_upstream/healthz;
        }

        location = /api/payments/healthz {
          proxy_pass http://payment_upstream/healthz;
        }

        location = /api/notification/healthz {
          proxy_pass http://notification_upstream/healthz;
        }

        location ~ ^/api/catalog(?<suffix>/?.*)$ {
          proxy_pass http://catalog_upstream/catalog$suffix;
        }

        location ~ ^/api/cart(?<suffix>/?.*)$ {
          proxy_pass http://cart_upstream/cart$suffix;
        }

        location ~ ^/api/orders(?<suffix>/?.*)$ {
          proxy_pass http://order_upstream/orders$suffix;
        }

        location ~ ^/api/recommendations(?<suffix>/?.*)$ {
          proxy_pass http://recommendation_upstream/recommendations$suffix;
        }

        location ~ ^/api/inventory(?<suffix>/?.*)$ {
          proxy_pass http://inventory_upstream/inventory$suffix;
        }

        location ~ ^/api/payments(?<suffix>/?.*)$ {
          proxy_pass http://payment_upstream/payments$suffix;
        }

        location ~ ^/api/notification(?<suffix>/?.*)$ {
          proxy_pass http://notification_upstream/notification$suffix;
        }

        location / {
          proxy_pass http://frontend_upstream/;
        }
      }
    }
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: edge-proxy
  namespace: {{ .Release.Namespace }}
  labels:
    app: edge-proxy
spec:
  replicas: {{ .Values.edgeProxy.replicas }}
  selector:
    matchLabels:
      app: edge-proxy
  template:
    metadata:
      labels:
        app: edge-proxy
    spec:
      {{- with .Values.global.nodeSelector }}
      nodeSelector:
        {{- toYaml . | nindent 8 }}
      {{- end }}
      {{- with .Values.global.tolerations }}
      tolerations:
        {{- toYaml . | nindent 8 }}
      {{- end }}
      containers:
        - name: nginx
          image: {{ .Values.edgeProxy.image }}
          imagePullPolicy: {{ .Values.global.imagePullPolicy }}
          ports:
            - containerPort: 80
              name: http
          volumeMounts:
            - name: config
              mountPath: /etc/nginx/nginx.conf
              subPath: nginx.conf
          readinessProbe:
            httpGet:
              path: /healthz
              port: 80
            initialDelaySeconds: 5
          livenessProbe:
            httpGet:
              path: /healthz
              port: 80
            initialDelaySeconds: 10
          resources: {{- toYaml .Values.edgeProxy.resources | nindent 12 }}
      volumes:
        - name: config
          configMap:
            name: edge-proxy-config
---
apiVersion: v1
kind: Service
metadata:
  name: edge-proxy
  namespace: {{ .Release.Namespace }}
  labels:
    app: edge-proxy
spec:
  selector:
    app: edge-proxy
  type: NodePort
  ports:
    - name: http
      port: 80
      targetPort: 80
      nodePort: {{ .Values.edgeProxy.nodePort }}
{{- end }}