{{- if .Values.services.recommendation.enabled }}
apiVersion: apps/v1
kind: Deployment
metadata:
  name: recommendation-service
  namespace: {{ .Release.Namespace }}
  labels:
    app: recommendation-service
spec:
  replicas: {{ .Values.services.recommendation.replicas }}
  strategy:
    rollingUpdate:
      maxUnavailable: 0
      maxSurge: 1
  selector:
    matchLabels:
      app: recommendation-service
  template:
    metadata:
      labels:
        app: recommendation-service
    spec:
      {{- with .Values.global.nodeSelector }}
      nodeSelector:
        {{- toYaml . | nindent 8 }}
      {{- end }}
      {{- with .Values.global.tolerations }}
      tolerations:
        {{- toYaml . | nindent 8 }}
      {{- end }}
      topologySpreadConstraints:
        - maxSkew: 1
          topologyKey: topology.kubernetes.io/zone
          whenUnsatisfiable: DoNotSchedule
          labelSelector:
            matchLabels:
              app: recommendation-service
      affinity:
        podAntiAffinity:
          preferredDuringSchedulingIgnoredDuringExecution:
            - weight: 100
              podAffinityTerm:
                topologyKey: kubernetes.io/hostname
                labelSelector:
                  matchLabels:
                    app: recommendation-service
      containers:
        - name: recommendation
          image: {{ .Values.services.recommendation.image }}
          imagePullPolicy: {{ .Values.global.imagePullPolicy }}
          ports:
            - containerPort: 8080
              name: http
            - containerPort: 50051
              name: grpc
          envFrom:
            - secretRef:
                name: recommendation-service-db
            - configMapRef:
                name: recommendation-service-config
          readinessProbe:
            httpGet:
              path: /healthz
              port: 8080
            initialDelaySeconds: 5
          livenessProbe:
            httpGet:
              path: /healthz
              port: 8080
            initialDelaySeconds: 10
          resources: {{- toYaml .Values.services.recommendation.resources | nindent 12 }}
---
apiVersion: policy/v1
kind: PodDisruptionBudget
metadata:
  name: recommendation-service-pdb
  namespace: {{ .Release.Namespace }}
  labels:
    app: recommendation-service
spec:
  minAvailable: {{ $.Values.pdb.servicesMinAvailable }}
  selector:
    matchLabels:
      app: recommendation-service
---
apiVersion: autoscaling/v2
kind: HorizontalPodAutoscaler
metadata:
  name: recommendation-service-hpa
  namespace: {{ .Release.Namespace }}
  labels:
    app: recommendation-service
spec:
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: recommendation-service
  minReplicas: {{ .Values.services.recommendation.replicas }}
  maxReplicas: {{ .Values.hpa.maxReplicas }}
  metrics:
    - type: Resource
      resource:
        name: cpu
        target:
          type: Utilization
          averageUtilization: {{ .Values.hpa.cpuAverageUtilization }}
---
apiVersion: v1
kind: Service
metadata:
  name: recommendation-service
  namespace: {{ .Release.Namespace }}
  labels:
    app: recommendation-service
spec:
  selector:
    app: recommendation-service
  ports:
    - name: http
      port: 8080
      targetPort: 8080
      appProtocol: http
    - name: grpc
      port: 50051
      targetPort: 50051
      appProtocol: grpc
  type: ClusterIP
{{- end }}