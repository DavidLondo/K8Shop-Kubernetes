{{- if .Values.rabbitmq.enabled }}
apiVersion: v1
kind: Service
metadata:
  name: rabbitmq
  namespace: {{ .Release.Namespace }}
  labels:
    app: rabbitmq
spec:
  type: ClusterIP
  selector:
    app: rabbitmq
  ports:
    - name: amqp
      port: 5672
      targetPort: 5672
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: rabbitmq-conf
  namespace: {{ .Release.Namespace }}
  labels:
    app: rabbitmq
data:
  rabbitmq.conf: |
    loopback_users.guest = false
    listeners.tcp.default = 5672
    default_user = user
    default_pass = password
    queue_master_locator = min-masters
  definitions.json: |
    {
      "users":[{"name":"user","password":"password","tags":"administrator"}],
      "vhosts":[{"name":"/"}],
      "permissions":[{"user":"user","vhost":"/","configure":".*","write":".*","read":".*"}],
      "policies":[
        {"vhost":"/","name":"ha-quorum","pattern":".*","apply-to":"queues",
         "definition":{"queue-type":"quorum","delivery-limit":5,"dead-letter-exchange":"orders.dlq"},
         "priority":0}
      ],
      "exchanges":[
        {"name":"orders","vhost":"/","type":"topic","durable":true,"internal":false,"auto_delete":false},
        {"name":"orders.dlq","vhost":"/","type":"topic","durable":true,"internal":false,"auto_delete":false}
      ]
    }
---
apiVersion: policy/v1
kind: PodDisruptionBudget
metadata:
  name: rabbitmq-pdb
  namespace: {{ .Release.Namespace }}
  labels:
    app: rabbitmq
spec:
  minAvailable: {{ .Values.rabbitmq.pdb.minAvailable }}
  selector:
    matchLabels:
      app: rabbitmq
---
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: rabbitmq
  namespace: {{ .Release.Namespace }}
  labels:
    app: rabbitmq
spec:
  serviceName: rabbitmq
  replicas: {{ .Values.rabbitmq.replicas }}
  selector:
    matchLabels:
      app: rabbitmq
  template:
    metadata:
      labels:
        app: rabbitmq
    spec:
      {{- with .Values.global.nodeSelector }}
      nodeSelector:
        {{- toYaml . | nindent 8 }}
      {{- end }}
      {{- with .Values.global.tolerations }}
      tolerations:
        {{- toYaml . | nindent 8 }}
      {{- end }}
      {{- with .Values.global.affinity }}
      affinity:
        {{- toYaml . | nindent 8 }}
      {{- end }}
      containers:
        - name: rabbitmq
          image: {{ .Values.rabbitmq.image }}
          imagePullPolicy: {{ .Values.global.imagePullPolicy }}
          ports:
            - containerPort: 5672
              name: amqp
          env:
            - name: RABBITMQ_USE_LONGNAME
              value: "false"
          volumeMounts:
            - name: data
              mountPath: /var/lib/rabbitmq
            - name: cfg
              mountPath: /etc/rabbitmq
          readinessProbe:
            exec:
              command: ["rabbitmq-diagnostics", "-q", "ping"]
            initialDelaySeconds: 40
            periodSeconds: 15
            timeoutSeconds: 10
            failureThreshold: 6
          livenessProbe:
            exec:
              command: ["rabbitmq-diagnostics", "-q", "check_running"]
            initialDelaySeconds: 90
            periodSeconds: 30
            timeoutSeconds: 10
            failureThreshold: 6
          resources: {{- toYaml .Values.rabbitmq.resources | nindent 12 }}
      volumes:
        - name: cfg
          configMap:
            name: rabbitmq-conf
            items:
              - key: rabbitmq.conf
                path: rabbitmq.conf
              - key: definitions.json
                path: definitions.json
        {{- if not .Values.rabbitmq.persistence.enabled }}
        - name: data
          emptyDir: {}
        {{- end }}
  {{- if .Values.rabbitmq.persistence.enabled }}
  volumeClaimTemplates:
    - metadata:
        name: data
      spec:
        accessModes: ["ReadWriteOnce"]
        resources:
          requests:
            storage: {{ default "5Gi" .Values.rabbitmq.persistence.size }}
  {{- end }}
{{- end }}